<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>公开留言区 - 昆承中学官网</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        github: '#24292e',
                        primary: '#2ea44f',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .message-appear {
                animation: fadeIn 0.5s ease-out;
            }
            .image-preview {
                max-width: 100%;
                max-height: 300px;
                object-fit: contain;
            }
            .touch-friendly {
                touch-action: manipulation;
                -webkit-tap-highlight-color: rgba(46, 164, 79, 0.2);
            }
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen text-gray-800">
    <!-- 登录状态检查脚本 -->
    <script>
        // 登录检查：仅允许已登录用户访问
        function checkLoginStatus() {
            const loginInfo = localStorage.getItem('loginInfo');
            if (!loginInfo) {
                window.location.href = 'login.html';
                return false;
            }
            
            const {expires} = JSON.parse(loginInfo);
            if (new Date().getTime() >= expires) {
                localStorage.removeItem('loginInfo');
                window.location.href = 'login.html';
                return false;
            }
            return true;
        }
        
        // 退出登录功能
        function logout() {
            localStorage.removeItem('loginInfo');
            window.location.href = 'login.html';
        }
        
        // 未登录则阻止页面加载
        if (!checkLoginStatus()) {
            document.write('<p class="text-center mt-10">请先登录...</p>');
        } else {
            // 获取当前登录用户信息
            const {username} = JSON.parse(localStorage.getItem('loginInfo'));
            // 页面加载后显示用户名
            document.addEventListener('DOMContentLoaded', () => {
                const userElement = document.getElementById('current-user');
                if (userElement) {
                    userElement.textContent = username;
                }
            });
        }
    </script>

    <!-- 导航栏（与其他页面统一） -->
    <header class="bg-gradient-to-r from-fbc2eb to-3b75da text-white py-4">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="text-2xl font-bold mb-4 md:mb-0">
                    <span class="highlight">昆承中学</span> 官网
                </div>
                <nav>
                    <ul class="flex flex-wrap justify-center gap-x-6 gap-y-2">
                        <li><a href="home.html" class="hover:underline">首页</a></li>
                        <li><a href="homestu.html" class="hover:underline">关于我们</a></li>
                        <li><a href="guestbook.html" class="font-bold underline">资源分享</a></li>
                        <li><a href="#" class="hover:underline">学生目录</a></li>
                        <li><a href="javascript:logout()" class="touch-friendly hover:underline">退出登录</a></li>
                        <li><span id="current-user" class="ml-2 text-sm opacity-90"></span></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 py-6 sm:py-8 max-w-4xl">
        <header class="text-center mb-6 sm:mb-12">
            <h1 class="text-[clamp(1.5rem,5vw,3rem)] font-bold text-github mb-2 flex items-center justify-center">
                <i class="fa fa-comments mr-3"></i>公开留言区
            </h1>
            <p class="text-gray-600 text-base sm:text-lg px-2">支持文字和图片留言，所有内容均公开存储</p>
        </header>
        
        <section id="guestbook-form-container" class="bg-white rounded-xl shadow-lg p-4 sm:p-6 mb-6 sm:mb-10">
            <h2 class="text-lg sm:text-xl font-semibold mb-4 text-github flex items-center">
                <i class="fa fa-pencil-square-o text-primary mr-2"></i>写下你的留言
            </h2>
            
            <form id="guestbook-form" class="space-y-4">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700 mb-1">昵称（≤50字符）</label>
                    <input 
                        type="text" 
                        id="name" 
                        required
                        maxlength="50"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all outline-none text-base"
                        placeholder="请输入你的昵称"
                    >
                </div>
                
                <div>
                    <label for="message" class="block text-sm font-medium text-gray-700 mb-1">留言内容（≤2000字符）</label>
                    <textarea 
                        id="message" 
                        rows="4" 
                        required
                        maxlength="2000"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all outline-none resize-none text-base"
                        placeholder="请输入你的留言..."
                    ></textarea>
                    <p class="mt-1 text-xs text-gray-500" id="char-count">0/2000 字符</p>
                </div>
                
                <!-- 图片上传区域（10MB限制） -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">上传图片（可选，≤10MB，支持jpg/png/gif）</label>
                    <div class="flex flex-col sm:flex-row items-center gap-4">
                        <label class="flex-1 border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-primary transition-colors cursor-pointer touch-friendly">
                            <input 
                                type="file" 
                                id="image-upload" 
                                accept="image/jpeg, image/png, image/gif" 
                                class="hidden"
                            >
                            <i class="fa fa-upload text-gray-400 text-xl mb-2"></i>
                            <p class="text-sm text-gray-500">点击或拖拽图片到此处</p>
                        </label>
                        
                        <div id="image-preview-container" class="hidden w-24 h-24 sm:w-32 sm:h-32 rounded-lg overflow-hidden border border-gray-200">
                            <img id="image-preview" class="image-preview" src="" alt="预览图">
                        </div>
                    </div>
                    <p id="image-size-error" class="mt-1 text-xs text-red-500 hidden">图片大小不能超过10MB</p>
                </div>
                
                <button 
                    type="submit" 
                    class="w-full sm:w-auto bg-primary hover:bg-primary/90 text-white font-medium py-3 px-6 rounded-lg transition-all transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 flex items-center justify-center touch-friendly"
                    id="submit-btn"
                >
                    <i class="fa fa-paper-plane mr-2"></i>发送留言
                </button>
            </form>
        </section>
        
        <section id="messages-control" class="mb-4 sm:mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
            <h2 class="text-lg sm:text-xl font-semibold text-github flex items-center">
                <i class="fa fa-list-alt text-primary mr-2"></i>所有留言
            </h2>
            
            <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3 w-full sm:w-auto">
                <span id="message-count" class="bg-gray-100 text-gray-600 px-3 py-1.5 rounded-full text-sm w-full sm:w-auto text-center">
                    加载中...
                </span>
                
                <div class="flex items-center border rounded-md overflow-hidden w-full sm:w-auto">
                    <button id="sort-newest" class="flex-1 sm:flex-none px-4 py-2 bg-primary text-white text-sm touch-friendly">最新在前</button>
                    <button id="sort-oldest" class="flex-1 sm:flex-none px-4 py-2 bg-gray-100 text-gray-700 text-sm hover:bg-gray-200 touch-friendly">最早在前</button>
                </div>
            </div>
        </section>
        
        <section id="messages-container">
            <div id="messages-list" class="space-y-4 sm:space-y-6">
                <div class="flex justify-center py-10">
                    <i class="fa fa-circle-o-notch fa-spin text-2xl text-gray-400"></i>
                </div>
            </div>
            
            <div class="mt-6 sm:mt-8 text-center">
                <button id="load-more" class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-3 px-6 rounded-lg transition-all focus:outline-none touch-friendly min-w-[160px]">
                    <i class="fa fa-refresh mr-2"></i>加载更多
                </button>
            </div>
        </section>
        
        <div id="error-alert" class="bg-red-50 border-l-4 border-red-400 p-4 mb-6 hidden">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="fa fa-exclamation-circle text-red-500"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm font-medium text-red-700 mb-1">操作失败</p>
                    <p id="error-message" class="text-sm text-red-700">发生错误，请重试</p>
                    <p class="mt-1 text-xs text-red-500" id="error-tips">建议检查网络连接</p>
                </div>
            </div>
        </div>
        
        <div id="success-alert" class="bg-green-50 border-l-4 border-green-400 p-4 mb-6 hidden">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="fa fa-check-circle text-green-500"></i>
                </div>
                <div class="ml-3">
                    <p id="success-message" class="text-sm text-green-700">操作成功</p>
                </div>
            </div>
        </div>
    </div>
    
    <footer class="bg-gray-100 py-6 mt-10 sm:mt-16">
        <div class="container mx-auto px-4 text-center text-gray-600 text-sm">
            <p>所有留言均公开存储 | <a href="https://github.com" class="text-primary hover:underline">GitHub</a></p>
        </div>
    </footer>

    <script>
        // 仅在登录状态有效时执行以下脚本
        if (checkLoginStatus()) {
            const CryptoUtils = {
                encrypt: function(str, shift = 3) {
                    let shifted = '';
                    for (let i = 0; i < str.length; i++) {
                        shifted += String.fromCharCode(str.charCodeAt(i) + shift);
                    }
                    return btoa(shifted);
                },
                decrypt: function(encryptedStr, shift = 3) {
                    try {
                        const shifted = atob(encryptedStr);
                        let original = '';
                        for (let i = 0; i < shifted.length; i++) {
                            original += String.fromCharCode(shifted.charCodeAt(i) - shift);
                        }
                        return original;
                    } catch (e) {
                        console.error('解密失败', e);
                        return '';
                    }
                }
            };
            
            const config = {
                owner: "fyk-666",  
                repo: "kczx",        
                branch: "main",          
                encryptedToken: "amtzYkZpcFhlb1lmZVM0PFM7R3hVRV1GekppNzRpTHdpfDdHdlk0Ug=="  
            };
            
            let githubConfig = {
                ...config,
                token: CryptoUtils.decrypt(config.encryptedToken)
            };
            
            let allMessages = [];
            let displayedMessages = [];
            let currentPage = 1;
            const messagesPerPage = 10;
            let sortOrder = 'newest';
            let selectedImage = null;
            
            // DOM元素
            const messagesList = document.getElementById('messages-list');
            const messageCount = document.getElementById('message-count');
            const errorAlert = document.getElementById('error-alert');
            const errorMessage = document.getElementById('error-message');
            const errorTips = document.getElementById('error-tips');
            const successAlert = document.getElementById('success-alert');
            const successMessage = document.getElementById('success-message');
            const loadMoreBtn = document.getElementById('load-more');
            const sortNewestBtn = document.getElementById('sort-newest');
            const sortOldestBtn = document.getElementById('sort-oldest');
            const messageInput = document.getElementById('message');
            const charCount = document.getElementById('char-count');
            const submitBtn = document.getElementById('submit-btn');
            const imageUpload = document.getElementById('image-upload');
            const imagePreview = document.getElementById('image-preview');
            const imagePreviewContainer = document.getElementById('image-preview-container');
            const imageSizeError = document.getElementById('image-size-error');
            
            // 字符计数
            messageInput.addEventListener('input', () => {
                const length = messageInput.value.length;
                charCount.textContent = `${length}/2000 字符`;
                if (length > 2000) {
                    charCount.classList.add('text-red-500');
                    submitBtn.disabled = true;
                } else {
                    charCount.classList.remove('text-red-500');
                    submitBtn.disabled = false;
                }
            });
            
            // 图片上传处理（10MB限制）
            imageUpload.addEventListener('change', handleImageSelect);
            
            // 拖拽上传
            const dropArea = document.querySelector('label[for="image-upload"]');
            dropArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropArea.classList.add('border-primary');
            });
            
            dropArea.addEventListener('dragleave', () => {
                dropArea.classList.remove('border-primary');
            });
            
            dropArea.addEventListener('drop', (e) => {
                e.preventDefault();
                dropArea.classList.remove('border-primary');
                if (e.dataTransfer.files.length) {
                    imageUpload.files = e.dataTransfer.files;
                    handleImageSelect({ target: imageUpload });
                }
            });
            
            dropArea.addEventListener('click', () => {
                imageUpload.click();
            });
            
            // 图片处理逻辑
            function handleImageSelect(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                // 验证文件类型
                if (!['image/jpeg', 'image/png', 'image/gif'].includes(file.type)) {
                    showError('不支持的文件类型', '仅支持jpg、png、gif格式的图片');
                    imageUpload.value = '';
                    return;
                }
                
                // 验证文件大小（10MB）
                if (file.size > 10 * 1024 * 1024) {
                    imageSizeError.classList.remove('hidden');
                    imageUpload.value = '';
                    selectedImage = null;
                    imagePreviewContainer.classList.add('hidden');
                    return;
                }
                
                imageSizeError.classList.add('hidden');
                selectedImage = file;
                
                // 预览图片
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                    imagePreviewContainer.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
            
            // 初始化留言区
            document.addEventListener('DOMContentLoaded', () => {
                loadAllMessages();
                
                document.getElementById('guestbook-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const name = document.getElementById('name').value.trim();
                    const message = document.getElementById('message').value.trim();
                    
                    if (!name || !message) {
                        showError('必填项不能为空', '昵称和留言内容为必填项');
                        return;
                    }
                    
                    try {
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>发送中...';
                        
                        let imageUrl = null;
                        // 上传图片
                        if (selectedImage) {
                            const imageFileName = `img-${Date.now()}-${Math.random().toString(36).substr(2, 8)}.${selectedImage.name.split('.').pop()}`;
                            const imageFilePath = `images/${imageFileName}`;
                            
                            // 转换图片为Base64
                            const imageContent = await new Promise((resolve) => {
                                const reader = new FileReader();
                                reader.onload = (e) => resolve(e.target.result.split(',')[1]);
                                reader.readAsDataURL(selectedImage);
                            });
                            
                            // 上传图片到GitHub
                            const imageResponse = await fetch(
                                `https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/${imageFilePath}`,
                                {
                                    method: 'PUT',
                                    headers: {
                                        'Authorization': `token ${githubConfig.token}`,
                                        'Accept': 'application/vnd.github.v3+json',
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({
                                        message: `Add image for guestbook entry: ${name}`,
                                        content: imageContent,
                                        branch: githubConfig.branch,
                                    }),
                                }
                            );
                            
                            if (!imageResponse.ok) {
                                throw new Error('图片上传失败，请重试');
                            }
                            
                            const imageData = await imageResponse.json();
                            imageUrl = imageData.content.download_url;
                        }
                        
                        // 创建留言对象
                        const newMessage = {
                            id: Date.now().toString(),
                            name: name,
                            message: message,
                            imageUrl: imageUrl,
                            timestamp: new Date().toISOString(),
                        };
                        
                        // 保存留言
                        const fileName = `${newMessage.timestamp.replace(/[:.]/g, '-')}-${newMessage.id.substring(0, 8)}.json`;
                        const filePath = `messages/${fileName}`;
                        
                        const jsonStr = JSON.stringify(newMessage, null, 2);
                        const utf8Bytes = new TextEncoder().encode(jsonStr);
                        const content = btoa(String.fromCharCode(...utf8Bytes));
                        
                        const response = await fetch(
                            `https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/${filePath}`,
                            {
                                method: 'PUT',
                                headers: {
                                    'Authorization': `token ${githubConfig.token}`,
                                    'Accept': 'application/vnd.github.v3+json',
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    message: `Add guestbook entry: ${name}`,
                                    content: content,
                                    branch: githubConfig.branch,
                                }),
                            }
                        );
                        
                        const responseData = await response.json();
                        if (response.ok) {
                            // 重置表单
                            document.getElementById('name').value = '';
                            document.getElementById('message').value = '';
                            charCount.textContent = '0/2000 字符';
                            imageUpload.value = '';
                            selectedImage = null;
                            imagePreviewContainer.classList.add('hidden');
                            
                            showSuccess('留言发送成功！');
                            loadAllMessages();
                        } else {
                            switch(response.status) {
                                case 401:
                                    throw new Error('权限验证失败：请联系管理员');
                                case 403:
                                    throw new Error('权限不足：请联系管理员');
                                case 404:
                                    throw new Error('路径不存在：请联系管理员');
                                default:
                                    throw new Error(`请求失败：${responseData.message || '未知错误'}`);
                            }
                        }
                    } catch (e) {
                        console.error('上传失败', e);
                        showError(e.message, '请稍后再试');
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="fa fa-paper-plane mr-2"></i>发送留言';
                    }
                });
                
                // 加载更多
                loadMoreBtn.addEventListener('click', () => {
                    currentPage++;
                    displayMessages();
                });
                
                // 排序按钮
                sortNewestBtn.addEventListener('click', () => {
                    if (sortOrder !== 'newest') {
                        sortOrder = 'newest';
                        updateSortButtons();
                        sortMessages();
                        currentPage = 1;
                        displayMessages();
                    }
                });
                
                sortOldestBtn.addEventListener('click', () => {
                    if (sortOrder !== 'oldest') {
                        sortOrder = 'oldest';
                        updateSortButtons();
                        sortMessages();
                        currentPage = 1;
                        displayMessages();
                    }
                });
            });
            
            // 更新排序按钮样式
            function updateSortButtons() {
                if (sortOrder === 'newest') {
                    sortNewestBtn.classList.add('bg-primary', 'text-white');
                    sortNewestBtn.classList.remove('bg-gray-100', 'text-gray-700');
                    sortOldestBtn.classList.add('bg-gray-100', 'text-gray-700');
                    sortOldestBtn.classList.remove('bg-primary', 'text-white');
                } else {
                    sortOldestBtn.classList.add('bg-primary', 'text-white');
                    sortOldestBtn.classList.remove('bg-gray-100', 'text-gray-700');
                    sortNewestBtn.classList.add('bg-gray-100', 'text-gray-700');
                    sortNewestBtn.classList.remove('bg-primary', 'text-white');
                }
            }
            
            // 加载所有留言
            async function loadAllMessages() {
                try {
                    messagesList.innerHTML = '<div class="flex justify-center py-10"><i class="fa fa-circle-o-notch fa-spin text-2xl text-gray-400"></i></div>';
                    loadMoreBtn.disabled = true;
                    loadMoreBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>加载中...';
                    
                    const response = await fetch(
                        `https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/messages?ref=${githubConfig.branch}`,
                        { headers: { 'Accept': 'application/vnd.github.v3+json' } }
                    );
                    
                    if (response.ok) {
                        const files = await response.json();
                        const jsonFiles = files.filter(file => file.name.endsWith('.json'));
                        
                        const messagesPromises = jsonFiles.map(file => 
                            fetch(file.download_url)
                                .then(res => res.json())
                                .then(msg => ({...msg, fileName: file.name}))
                                .catch(err => {
                                    console.error(`加载留言 ${file.name} 失败`, err);
                                    return null;
                                })
                        );
                        
                        const messages = await Promise.all(messagesPromises);
                        allMessages = messages.filter(Boolean);
                        sortMessages();
                        messageCount.textContent = `${allMessages.length} 条留言`;
                        currentPage = 1;
                        displayMessages();
                    } else if (response.status === 404) {
                        allMessages = [];
                        messageCount.textContent = '0 条留言';
                        messagesList.innerHTML = `
                            <div class="text-center py-10 bg-yellow-50 rounded-lg">
                                <i class="fa fa-folder-open-o text-4xl text-yellow-300 mb-3"></i>
                                <p class="text-yellow-700 mb-2">留言区准备中</p>
                                <p class="text-sm text-yellow-600">这是第一条留言，快来抢占沙发吧！</p>
                            </div>
                        `;
                        loadMoreBtn.disabled = true;
                    } else {
                        const errData = await response.json();
                        throw new Error(`加载失败：${errData.message || '请联系管理员'}`);
                    }
                } catch (e) {
                    console.error('加载留言失败', e);
                    messagesList.innerHTML = `
                        <div class="text-center py-10 bg-red-50 rounded-lg">
                            <i class="fa fa-exclamation-triangle text-4xl text-red-300 mb-3"></i>
                            <p class="text-red-700">${e.message}</p>
                            <button onclick="loadAllMessages()" class="mt-3 text-sm text-primary hover:underline">
                                点击重试
                            </button>
                        </div>
                    `;
                    loadMoreBtn.disabled = false;
                    loadMoreBtn.innerHTML = '<i class="fa fa-refresh mr-2"></i>重试加载';
                }
            }
            
            // 排序留言
            function sortMessages() {
                allMessages.sort((a, b) => {
                    const dateA = new Date(a.timestamp).getTime();
                    const dateB = new Date(b.timestamp).getTime();
                    return sortOrder === 'newest' ? dateB - dateA : dateA - dateB;
                });
            }
            
            // 显示留言
            function displayMessages() {
                if (allMessages.length === 0) {
                    messagesList.innerHTML = `
                        <div class="text-center py-10 bg-gray-50 rounded-lg">
                            <i class="fa fa-comment-o text-4xl text-gray-300 mb-3"></i>
                            <p class="text-gray-500">还没有留言，快来写下第一条吧！</p>
                        </div>
                    `;
                    loadMoreBtn.disabled = true;
                    loadMoreBtn.innerHTML = '<i class="fa fa-check mr-2"></i>没有更多留言';
                    return;
                }
                
                const startIndex = (currentPage - 1) * messagesPerPage;
                const endIndex = startIndex + messagesPerPage;
                displayedMessages = allMessages.slice(startIndex, endIndex);
                
                if (currentPage === 1) messagesList.innerHTML = '';
                
                displayedMessages.forEach(message => {
                    const messageElement = document.createElement('div');
                    messageElement.className = 'bg-white rounded-xl shadow-md p-4 sm:p-6 hover:shadow-lg transition-shadow message-appear';
                    
                    // 构建留言内容（含图片）
                    let contentHtml = `<div class="text-gray-700 whitespace-pre-line">${escapeHtml(message.message)}</div>`;
                    if (message.imageUrl) {
                        contentHtml += `
                            <div class="mt-3 rounded-lg overflow-hidden border border-gray-100">
                                <img src="${message.imageUrl}" class="w-full image-preview" alt="留言图片">
                            </div>
                        `;
                    }
                    
                    messageElement.innerHTML = `
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex items-center">
                                <div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-600 font-bold mr-3">
                                    ${message.name.charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <h3 class="font-semibold text-gray-900">${escapeHtml(message.name)}</h3>
                                </div>
                            </div>
                            <span class="text-sm text-gray-400">${formatDate(message.timestamp)}</span>
                        </div>
                        ${contentHtml}
                    `;
                    messagesList.appendChild(messageElement);
                });
                
                if (endIndex >= allMessages.length) {
                    loadMoreBtn.disabled = true;
                    loadMoreBtn.innerHTML = '<i class="fa fa-check mr-2"></i>没有更多留言';
                } else {
                    loadMoreBtn.disabled = false;
                    loadMoreBtn.innerHTML = '<i class="fa fa-refresh mr-2"></i>加载更多';
                }
            }
            
            // 格式化日期
            function formatDate(dateString) {
                const date = new Date(dateString);
                return new Intl.DateTimeFormat('zh-CN', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }).format(date);
            }
            
            // HTML转义
            function escapeHtml(unsafe) {
                return unsafe
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }
            
            // 显示错误提示
            function showError(msg, tips = '') {
                errorMessage.textContent = msg;
                errorTips.textContent = tips ? `提示：${tips}` : '建议检查网络连接';
                errorAlert.classList.remove('hidden');
                setTimeout(() => errorAlert.classList.add('hidden'), 8000);
            }
            
            // 显示成功提示
            function showSuccess(msg) {
                successMessage.textContent = msg;
                successAlert.classList.remove('hidden');
                setTimeout(() => successAlert.classList.add('hidden'), 3000);
            }
        }
    </script>
</body>
</html>
