<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>公开留言区 - 昆承中学官网</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        github: '#24292e',
                        primary: '#2ea44f',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .message-appear {
                animation: fadeIn 0.5s ease-out;
            }
            .image-preview {
                max-width: 100%;
                max-height: 300px;
                object-fit: contain;
            }
            .touch-friendly {
                touch-action: manipulation;
                -webkit-tap-highlight-color: rgba(46, 164, 79, 0.2);
            }
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen text-gray-800">
    <!-- 导航栏 -->
    <header class="bg-gradient-to-r from-fbc2eb to-3b75da text-white py-4">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="text-2xl font-bold mb-4 md:mb-0">
                    <span class="highlight">昆承中学</span> 官网
                </div>
                <nav>
                    <ul class="flex flex-wrap justify-center gap-x-6 gap-y-2">
                        <li><a href="home.html" class="hover:underline">首页</a></li>
                        <li><a href="homestu.html" class="hover:underline">关于我们</a></li>
                        <li><a href="guestbook.html" class="font-bold underline">资源分享</a></li>
                        <li><a href="#" class="hover:underline">学生目录</a></li>
                        <li><a href="javascript:logout()" class="touch-friendly hover:underline">退出登录</a></li>
                        <li><span id="current-user" class="ml-2 text-sm opacity-90"></span></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 py-6 sm:py-8 max-w-4xl">
        <header class="text-center mb-6 sm:mb-12">
            <h1 class="text-[clamp(1.5rem,5vw,3rem)] font-bold text-github mb-2 flex items-center justify-center">
                <i class="fa fa-comments mr-3"></i>公开留言区
            </h1>
            <p class="text-gray-600 text-base sm:text-lg px-2">支持文字和图片留言，所有内容均公开存储</p>
        </header>
        
        <!-- 留言表单 -->
        <section id="guestbook-form-container" class="bg-white rounded-xl shadow-lg p-4 sm:p-6 mb-6 sm:mb-10">
            <h2 class="text-lg sm:text-xl font-semibold mb-4 text-github flex items-center">
                <i class="fa fa-pencil-square-o text-primary mr-2"></i>写下你的留言
            </h2>
            
            <form id="guestbook-form" class="space-y-4">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700 mb-1">昵称（≤50字符）</label>
                    <input 
                        type="text" 
                        id="name" 
                        required
                        maxlength="50"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all outline-none text-base"
                        placeholder="请输入你的昵称"
                    >
                </div>
                
                <div>
                    <label for="message" class="block text-sm font-medium text-gray-700 mb-1">留言内容（≤2000字符）</label>
                    <textarea 
                        id="message" 
                        rows="4" 
                        required
                        maxlength="2000"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all outline-none resize-none text-base"
                        placeholder="请输入你的留言..."
                    ></textarea>
                    <p class="mt-1 text-xs text-gray-500" id="char-count">0/2000 字符</p>
                </div>
                
                <!-- 图片上传区域 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">上传图片（可选，≤10MB，支持jpg/png/gif）</label>
                    <div class="flex flex-col sm:flex-row items-center gap-4">
                        <label class="flex-1 border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-primary transition-colors cursor-pointer touch-friendly" id="image-drop-area">
                            <input 
                                type="file" 
                                id="image-upload" 
                                accept="image/jpeg, image/png, image/gif" 
                                class="hidden"
                            >
                            <i class="fa fa-upload text-gray-400 text-xl mb-2"></i>
                            <p class="text-sm text-gray-500">点击或拖拽图片到此处</p>
                        </label>
                        
                        <div id="image-preview-container" class="hidden w-24 h-24 sm:w-32 sm:h-32 rounded-lg overflow-hidden border border-gray-200">
                            <img id="image-preview" class="image-preview" src="" alt="预览图">
                        </div>
                    </div>
                    <p id="image-size-error" class="mt-1 text-xs text-red-500 hidden">图片大小不能超过10MB</p>
                </div>
                
                <button 
                    type="submit" 
                    class="w-full sm:w-auto bg-primary hover:bg-primary/90 text-white font-medium py-3 px-6 rounded-lg transition-all transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 flex items-center justify-center touch-friendly"
                    id="submit-btn"
                >
                    <i class="fa fa-paper-plane mr-2"></i>发送留言
                </button>
            </form>
        </section>
        
        <!-- 留言控制区 -->
        <section id="messages-control" class="mb-4 sm:mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
            <h2 class="text-lg sm:text-xl font-semibold text-github flex items-center">
                <i class="fa fa-list-alt text-primary mr-2"></i>所有留言
            </h2>
            
            <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3 w-full sm:w-auto">
                <span id="message-count" class="bg-gray-100 text-gray-600 px-3 py-1.5 rounded-full text-sm w-full sm:w-auto text-center">
                    加载中...
                </span>
                
                <div class="flex items-center border rounded-md overflow-hidden w-full sm:w-auto">
                    <button id="sort-newest" class="flex-1 sm:flex-none px-4 py-2 bg-primary text-white text-sm touch-friendly">最新在前</button>
                    <button id="sort-oldest" class="flex-1 sm:flex-none px-4 py-2 bg-gray-100 text-gray-700 text-sm hover:bg-gray-200 touch-friendly">最早在前</button>
                </div>
            </div>
        </section>
        
        <!-- 留言列表 -->
        <section id="messages-container">
            <div id="messages-list" class="space-y-4 sm:space-y-6">
                <div class="flex justify-center py-10">
                    <i class="fa fa-circle-o-notch fa-spin text-2xl text-gray-400"></i>
                </div>
            </div>
            
            <div class="mt-6 sm:mt-8 text-center">
                <button id="load-more" class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-3 px-6 rounded-lg transition-all focus:outline-none touch-friendly min-w-[160px]">
                    <i class="fa fa-refresh mr-2"></i>加载更多
                </button>
            </div>
        </section>
        
        <!-- 提示框 -->
        <div id="error-alert" class="bg-red-50 border-l-4 border-red-400 p-4 mb-6 hidden">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="fa fa-exclamation-circle text-red-500"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm font-medium text-red-700 mb-1">操作失败</p>
                    <p id="error-message" class="text-sm text-red-700">发生错误，请重试</p>
                    <p class="mt-1 text-xs text-red-500" id="error-tips">建议检查网络连接</p>
                </div>
            </div>
        </div>
        
        <div id="success-alert" class="bg-green-50 border-l-4 border-green-400 p-4 mb-6 hidden">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="fa fa-check-circle text-green-500"></i>
                </div>
                <div class="ml-3">
                    <p id="success-message" class="text-sm text-green-700">操作成功</p>
                </div>
            </div>
        </div>
    </div>
    
    <footer class="bg-gray-100 py-6 mt-10 sm:mt-16">
        <div class="container mx-auto px-4 text-center text-gray-600 text-sm">
            <p>所有留言均公开存储 | <a href="https://github.com" class="text-primary hover:underline">GitHub</a></p>
        </div>
    </footer>

    <script>
        // 登录状态检查（提前定义，无DOM依赖）
        function checkLoginStatus() {
            const loginInfo = localStorage.getItem('loginInfo');
            if (!loginInfo) return false;
            
            const { expires } = JSON.parse(loginInfo);
            if (new Date().getTime() >= expires) {
                localStorage.removeItem('loginInfo');
                return false;
            }
            return true;
        }
        
        function logout() {
            localStorage.removeItem('loginInfo');
            window.location.href = 'login.html';
        }
        
        // 等待DOM加载完成后执行所有逻辑
        document.addEventListener('DOMContentLoaded', () => {
            // 未登录处理
            if (!checkLoginStatus()) {
                const pageContent = document.querySelector('.container.max-w-4xl');
                const header = document.querySelector('header');
                if (pageContent) pageContent.innerHTML = '';
                if (header) header.style.display = 'none';
                
                const loginTip = document.createElement('div');
                loginTip.style.cssText = `
                    text-align: center; margin-top: 100px; font-size: 18px;
                    padding: 20px; background: white; width: 80%; max-width: 500px;
                    margin-left: auto; margin-right: auto; border-radius: 10px;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                `;
                loginTip.innerHTML = `
                    <p>请先登录才能访问留言区</p>
                    <button onclick="window.location.href='login.html'" style="margin-top:15px; padding:8px 20px; background:#3b75da; color:white; border:none; border-radius:5px; cursor:pointer;">
                        前往登录
                    </button>
                `;
                document.body.appendChild(loginTip);
                return;
            }
            
            // 显示当前用户
            const { username } = JSON.parse(localStorage.getItem('loginInfo'));
            const userElement = document.getElementById('current-user');
            if (userElement) userElement.textContent = `（当前登录：${username}）`;
            
            // 加密工具
            const CryptoUtils = {
                encrypt: (str, shift = 3) => btoa([...str].map(c => String.fromCharCode(c.charCodeAt(0) + shift)).join('')),
                decrypt: (encryptedStr, shift = 3) => {
                    try {
                        return [...atob(encryptedStr)].map(c => String.fromCharCode(c.charCodeAt(0) - shift)).join('');
                    } catch (e) {
                        console.error('解密失败:', e);
                        return '';
                    }
                }
            };
            
            // GitHub配置（重点检查仓库路径和token）
            const config = {
                owner: "fyk-666",  
                repo: "kczx",        
                branch: "main",          
                encryptedToken: "amtzYkZpcFhlb1lmZVM0PFM7R3hVRV1GekppNzRpTHdpfDdHdlk0Ug=="  
            };
            const githubConfig = { ...config, token: CryptoUtils.decrypt(config.encryptedToken) };
            console.log('GitHub配置检查:', { owner: githubConfig.owner, repo: githubConfig.repo, token: !!githubConfig.token ? '存在' : '缺失' });
            
            // 全局变量
            let allMessages = [];
            let currentPage = 1;
            const messagesPerPage = 10;
            let sortOrder = 'newest';
            let selectedImage = null;
            
            // DOM元素
            const dom = {
                messagesList: document.getElementById('messages-list'),
                messageCount: document.getElementById('message-count'),
                loadMoreBtn: document.getElementById('load-more'),
                sortNewestBtn: document.getElementById('sort-newest'),
                sortOldestBtn: document.getElementById('sort-oldest'),
                messageInput: document.getElementById('message'),
                charCount: document.getElementById('char-count'),
                submitBtn: document.getElementById('submit-btn'),
                imageUpload: document.getElementById('image-upload'),
                imagePreview: document.getElementById('image-preview'),
                imagePreviewContainer: document.getElementById('image-preview-container'),
                imageSizeError: document.getElementById('image-size-error'),
                guestbookForm: document.getElementById('guestbook-form'),
                imageDropArea: document.getElementById('image-drop-area'),
                errorAlert: document.getElementById('error-alert'),
                errorMessage: document.getElementById('error-message'),
                errorTips: document.getElementById('error-tips'),
                successAlert: document.getElementById('success-alert'),
                successMessage: document.getElementById('success-message')
            };
            
            // 字符计数
            if (dom.messageInput && dom.charCount) {
                dom.messageInput.addEventListener('input', () => {
                    const len = dom.messageInput.value.length;
                    dom.charCount.textContent = `${len}/2000 字符`;
                    dom.submitBtn.disabled = len > 2000;
                    dom.charCount.classList.toggle('text-red-500', len > 2000);
                });
            }
            
            // 图片上传处理
            function handleImageSelect(e) {
                const file = e.target.files?.[0];
                if (!file) return;
                
                if (!['image/jpeg', 'image/png', 'image/gif'].includes(file.type)) {
                    showError('不支持的文件类型', '仅支持jpg、png、gif');
                    dom.imageUpload.value = '';
                    return;
                }
                
                if (file.size > 10 * 1024 * 1024) {
                    dom.imageSizeError.classList.remove('hidden');
                    dom.imageUpload.value = '';
                    selectedImage = null;
                    dom.imagePreviewContainer.classList.add('hidden');
                    return;
                }
                
                dom.imageSizeError.classList.add('hidden');
                selectedImage = file;
                const reader = new FileReader();
                reader.onload = e => {
                    dom.imagePreview.src = e.target.result;
                    dom.imagePreviewContainer.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
            
            // 拖拽上传
            if (dom.imageDropArea && dom.imageUpload) {
                dom.imageDropArea.addEventListener('dragover', e => {
                    e.preventDefault();
                    dom.imageDropArea.classList.add('border-primary');
                });
                
                dom.imageDropArea.addEventListener('dragleave', () => {
                    dom.imageDropArea.classList.remove('border-primary');
                });
                
                dom.imageDropArea.addEventListener('drop', e => {
                    e.preventDefault();
                    dom.imageDropArea.classList.remove('border-primary');
                    if (e.dataTransfer.files.length) {
                        dom.imageUpload.files = e.dataTransfer.files;
                        handleImageSelect({ target: dom.imageUpload });
                    }
                });
                
                dom.imageDropArea.addEventListener('click', () => dom.imageUpload.click());
                dom.imageUpload.addEventListener('change', handleImageSelect);
            }
            
            // 表单提交
            if (dom.guestbookForm) {
                dom.guestbookForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const name = document.getElementById('name').value.trim();
                    const message = dom.messageInput.value.trim();
                    
                    if (!name || !message) {
                        showError('必填项不能为空', '请填写昵称和留言内容');
                        return;
                    }
                    
                    dom.submitBtn.disabled = true;
                    dom.submitBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>发送中...';
                    
                    try {
                        // 上传图片（如有）
                        let imageUrl = null;
                        if (selectedImage) {
                            const fileName = `img-${Date.now()}-${Math.random().toString(36).slice(2, 8)}.${selectedImage.name.split('.').pop()}`;
                            const imageContent = await new Promise((resolve, reject) => {
                                const reader = new FileReader();
                                reader.onload = e => resolve(e.target.result.split(',')[1]);
                                reader.onerror = reject;
                                reader.readAsDataURL(selectedImage);
                            });
                            
                            const res = await fetchWithTimeout(
                                `https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/images/${fileName}`,
                                {
                                    method: 'PUT',
                                    headers: {
                                        'Authorization': `token ${githubConfig.token}`,
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({
                                        message: `Add image: ${name}`,
                                        content: imageContent,
                                        branch: githubConfig.branch
                                    })
                                },
                                15000 // 15秒超时
                            );
                            
                            if (!res.ok) throw new Error(`图片上传失败（${res.status}）`);
                            const data = await res.json();
                            imageUrl = data.content.download_url;
                        }
                        
                        // 保存留言
                        const msgFileName = `${new Date().toISOString().replace(/[:.]/g, '-')}-${Date.now().toString().slice(0, 8)}.json`;
                        const msgContent = btoa(String.fromCharCode(...new TextEncoder().encode(JSON.stringify({
                            id: Date.now().toString(),
                            name,
                            message,
                            imageUrl,
                            timestamp: new Date().toISOString()
                        }, null, 2))));
                        
                        const res = await fetchWithTimeout(
                            `https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/messages/${msgFileName}`,
                            {
                                method: 'PUT',
                                headers: {
                                    'Authorization': `token ${githubConfig.token}`,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    message: `Add message: ${name}`,
                                    content: msgContent,
                                    branch: githubConfig.branch
                                })
                            },
                            15000
                        );
                        
                        if (!res.ok) {
                            const err = await res.json().catch(() => ({ message: '未知错误' }));
                            throw new Error(`留言保存失败：${err.message}（${res.status}）`);
                        }
                        
                        // 重置表单
                        document.getElementById('name').value = '';
                        dom.messageInput.value = '';
                        dom.charCount.textContent = '0/2000 字符';
                        dom.imageUpload.value = '';
                        dom.imagePreviewContainer.classList.add('hidden');
                        selectedImage = null;
                        
                        showSuccess('留言发送成功！');
                        loadAllMessages(); // 重新加载留言
                    } catch (e) {
                        console.error('提交失败:', e);
                        showError(e.message, '请检查网络或联系管理员');
                    } finally {
                        dom.submitBtn.disabled = false;
                        dom.submitBtn.innerHTML = '<i class="fa fa-paper-plane mr-2"></i>发送留言';
                    }
                });
            }
            
            // 排序按钮
            if (dom.sortNewestBtn && dom.sortOldestBtn) {
                const updateSortButtons = () => {
                    if (sortOrder === 'newest') {
                        dom.sortNewestBtn.classList.add('bg-primary', 'text-white');
                        dom.sortNewestBtn.classList.remove('bg-gray-100', 'text-gray-700');
                        dom.sortOldestBtn.classList.add('bg-gray-100', 'text-gray-700');
                        dom.sortOldestBtn.classList.remove('bg-primary', 'text-white');
                    } else {
                        dom.sortOldestBtn.classList.add('bg-primary', 'text-white');
                        dom.sortOldestBtn.classList.remove('bg-gray-100', 'text-gray-700');
                        dom.sortNewestBtn.classList.add('bg-gray-100', 'text-gray-700');
                        dom.sortNewestBtn.classList.remove('bg-primary', 'text-white');
                    }
                };
                
                dom.sortNewestBtn.addEventListener('click', () => {
                    if (sortOrder !== 'newest') {
                        sortOrder = 'newest';
                        updateSortButtons();
                        sortMessages();
                        currentPage = 1;
                        displayMessages();
                    }
                });
                
                dom.sortOldestBtn.addEventListener('click', () => {
                    if (sortOrder !== 'oldest') {
                        sortOrder = 'oldest';
                        updateSortButtons();
                        sortMessages();
                        currentPage = 1;
                        displayMessages();
                    }
                });
            }
            
            // 加载更多
            if (dom.loadMoreBtn) {
                dom.loadMoreBtn.addEventListener('click', () => {
                    currentPage++;
                    displayMessages();
                });
            }
            
            // 【核心修复】带超时的fetch请求
            function fetchWithTimeout(url, options, timeout = 10000) {
                return Promise.race([
                    fetch(url, options),
                    new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('请求超时（超过10秒）')), timeout)
                    )
                ]);
            }
            
            // 【核心修复】加载所有留言（重点优化错误处理）
            async function loadAllMessages() {
                // 重置加载状态
                if (dom.messagesList) {
                    dom.messagesList.innerHTML = '<div class="flex justify-center py-10"><i class="fa fa-circle-o-notch fa-spin text-2xl text-gray-400"></i></div>';
                }
                if (dom.loadMoreBtn) {
                    dom.loadMoreBtn.disabled = true;
                    dom.loadMoreBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>加载中...';
                }
                if (dom.messageCount) dom.messageCount.textContent = '加载中...';
                
                try {
                    console.log('开始加载留言列表...');
                    // 1. 请求messages目录下的文件列表
                    const res = await fetchWithTimeout(
                        `https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/messages?ref=${githubConfig.branch}`,
                        { headers: { 'Accept': 'application/vnd.github.v3+json' } },
                        10000 // 10秒超时
                    );
                    
                    console.log('文件列表请求状态:', res.status);
                    
                    // 2. 处理响应状态
                    if (!res.ok) {
                        if (res.status === 404) {
                            // 目录不存在（首次使用时正常）
                            allMessages = [];
                            if (dom.messagesList) {
                                dom.messagesList.innerHTML = `
                                    <div class="text-center py-10 bg-yellow-50 rounded-lg">
                                        <i class="fa fa-folder-open-o text-4xl text-yellow-300 mb-3"></i>
                                        <p class="text-yellow-700 mb-2">留言区准备就绪</p>
                                        <p class="text-sm text-yellow-600">还没有留言，快来写下第一条吧！</p>
                                    </div>
                                `;
                            }
                            if (dom.messageCount) dom.messageCount.textContent = '0 条留言';
                            return;
                        } else if (res.status === 403) {
                            throw new Error('权限不足（403）：可能是token无效或仓库私有');
                        } else if (res.status === 401) {
                            throw new Error('未授权（401）：token验证失败');
                        } else {
                            throw new Error(`请求失败（${res.status}）：服务器错误`);
                        }
                    }
                    
                    // 3. 解析文件列表
                    const files = await res.json();
                    const jsonFiles = files.filter(file => file.name.endsWith('.json'));
                    console.log(`发现${jsonFiles.length}个留言文件`);
                    
                    if (jsonFiles.length === 0) {
                        allMessages = [];
                        if (dom.messagesList) {
                            dom.messagesList.innerHTML = `
                                <div class="text-center py-10 bg-gray-50 rounded-lg">
                                    <i class="fa fa-comment-o text-4xl text-gray-300 mb-3"></i>
                                    <p class="text-gray-500">还没有留言，快来写下第一条吧！</p>
                                </div>
                            `;
                        }
                        if (dom.messageCount) dom.messageCount.textContent = '0 条留言';
                        return;
                    }
                    
                    // 4. 加载并解析每个留言文件
                    const messagesPromises = jsonFiles.map(file => 
                        fetchWithTimeout(file.download_url, {}, 5000)
                            .then(res => res.json())
                            .then(msg => ({ ...msg, fileName: file.name }))
                            .catch(err => {
                                console.error(`加载单个留言失败（${file.name}）:`, err);
                                return null; // 单个失败不影响整体
                            })
                    );
                    
                    const messages = await Promise.all(messagesPromises);
                    allMessages = messages.filter(Boolean); // 过滤失败的留言
                    console.log(`成功加载${allMessages.length}条留言`);
                    
                    // 5. 排序并显示
                    sortMessages();
                    if (dom.messageCount) dom.messageCount.textContent = `${allMessages.length} 条留言`;
                    currentPage = 1;
                    displayMessages();
                    
                } catch (e) {
                    console.error('加载留言失败:', e);
                    // 显示具体错误信息
                    if (dom.messagesList) {
                        dom.messagesList.innerHTML = `
                            <div class="text-center py-10 bg-red-50 rounded-lg">
                                <i class="fa fa-exclamation-triangle text-4xl text-red-300 mb-3"></i>
                                <p class="text-red-700 mb-2">${e.message}</p>
                                <button onclick="loadAllMessages()" class="mt-3 px-4 py-2 bg-primary text-white rounded hover:bg-primary/90">
                                    重试加载
                                </button>
                            </div>
                        `;
                    }
                    if (dom.loadMoreBtn) {
                        dom.loadMoreBtn.disabled = false;
                        dom.loadMoreBtn.innerHTML = '<i class="fa fa-refresh mr-2"></i>重试加载';
                    }
                }
            }
            
            // 排序留言
            function sortMessages() {
                allMessages.sort((a, b) => {
                    const timeA = new Date(a.timestamp).getTime();
                    const timeB = new Date(b.timestamp).getTime();
                    return sortOrder === 'newest' ? timeB - timeA : timeA - timeB;
                });
            }
            
            // 显示留言
            function displayMessages() {
                if (!dom.messagesList || !dom.loadMoreBtn) return;
                
                if (allMessages.length === 0) {
                    dom.messagesList.innerHTML = `
                        <div class="text-center py-10 bg-gray-50 rounded-lg">
                            <i class="fa fa-comment-o text-4xl text-gray-300 mb-3"></i>
                            <p class="text-gray-500">还没有留言，快来写下第一条吧！</p>
                        </div>
                    `;
                    dom.loadMoreBtn.disabled = true;
                    dom.loadMoreBtn.innerHTML = '<i class="fa fa-check mr-2"></i>没有更多留言';
                    return;
                }
                
                const start = (currentPage - 1) * messagesPerPage;
                const end = start + messagesPerPage;
                const currentMessages = allMessages.slice(start, end);
                
                if (currentPage === 1) dom.messagesList.innerHTML = '';
                
                currentMessages.forEach(msg => {
                    const el = document.createElement('div');
                    el.className = 'bg-white rounded-xl shadow-md p-4 sm:p-6 hover:shadow-lg transition-shadow message-appear';
                    
                    let content = `<div class="text-gray-700 whitespace-pre-line">${escapeHtml(msg.message)}</div>`;
                    if (msg.imageUrl) {
                        content += `
                            <div class="mt-3 rounded-lg overflow-hidden border border-gray-100">
                                <img src="${msg.imageUrl}" class="w-full image-preview" alt="留言图片">
                            </div>
                        `;
                    }
                    
                    el.innerHTML = `
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex items-center">
                                <div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-600 font-bold mr-3">
                                    ${msg.name.charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <h3 class="font-semibold text-gray-900">${escapeHtml(msg.name)}</h3>
                                </div>
                            </div>
                            <span class="text-sm text-gray-400">${formatDate(msg.timestamp)}</span>
                        </div>
                        ${content}
                    `;
                    dom.messagesList.appendChild(el);
                });
                
                // 更新加载更多按钮
                if (end >= allMessages.length) {
                    dom.loadMoreBtn.disabled = true;
                    dom.loadMoreBtn.innerHTML = '<i class="fa fa-check mr-2"></i>没有更多留言';
                } else {
                    dom.loadMoreBtn.disabled = false;
                    dom.loadMoreBtn.innerHTML = '<i class="fa fa-refresh mr-2"></i>加载更多';
                }
            }
            
            // 工具函数
            function formatDate(dateStr) {
                return new Intl.DateTimeFormat('zh-CN', {
                    year: 'numeric', month: 'long', day: 'numeric',
                    hour: '2-digit', minute: '2-digit'
                }).format(new Date(dateStr));
            }
            
            function escapeHtml(str) {
                return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;').replace(/'/g, '&#039;');
            }
            
            function showError(msg, tips) {
                if (dom.errorMessage && dom.errorTips && dom.errorAlert) {
                    dom.errorMessage.textContent = msg;
                    dom.errorTips.textContent = tips ? `提示：${tips}` : '请检查网络';
                    dom.errorAlert.classList.remove('hidden');
                    setTimeout(() => dom.errorAlert.classList.add('hidden'), 8000);
                }
            }
            
            function showSuccess(msg) {
                if (dom.successMessage && dom.successAlert) {
                    dom.successMessage.textContent = msg;
                    dom.successAlert.classList.remove('hidden');
                    setTimeout(() => dom.successAlert.classList.add('hidden'), 3000);
                }
            }
            
            // 暴露全局函数（供重试按钮调用）
            window.loadAllMessages = loadAllMessages;
            
            // 初始化加载留言
            loadAllMessages();
        });
    </script>
</body>
</html>
